//
//  MapViewController.swift
//  Internator
//
//  Created by ra3571 on 1/12/15.
//  Copyright (c) 2015 Freescale. All rights reserved.
//
// TODO: add overlay of site image that is clickable 

import UIKit
import CoreLocation
import MapKit
import AddressBookUI
import CoreData


class MapViewController: UIViewController, CLLocationManagerDelegate, MKMapViewDelegate {

    @IBOutlet weak var mapView: MKMapView!

    var annotationUrl: String?   // this is the URL that contains the annotations to display
    var annotationToImage: NSMutableDictionary?
    
    // use core data to get the data for a site
    var sites = [NSManagedObject]()
    
    override func viewDidLoad() {
        super.viewDidLoad()

        // add anotations to the map using annotationUrl as specified
        loadAnnotations()
    }
    
    
    // return a custom "pin" for Locations
    func mapView(mapView: MKMapView!, viewForAnnotation annotation: MKAnnotation!) -> MKAnnotationView! {
        
        // dont change the MKUserLocationView
        if annotation is MKUserLocation {
            return nil
        }
        
        // this will display a custom MKAnnotationView
        let reuseId = "pin"
        var pinView = mapView.dequeueReusableAnnotationViewWithIdentifier(reuseId)
        if pinView == nil {
            pinView = MKAnnotationView (annotation: annotation, reuseIdentifier: reuseId)
            pinView!.canShowCallout = true
   
            // add a custom image TODO: use the icon as indicated in the json file
            if let imageURLStr: String = annotationToImage?[annotation.title!] as? String {
                var imageUrl = NSURL(fileURLWithPath: annotationUrl!)
                // if scheme is "file", then the format is just the file name like foo.json or foo.png
                if imageUrl?.scheme! == "file" {
                    let fileNameWithoutExt = imageURLStr.stringByDeletingPathExtension
                    let ext = imageURLStr.pathExtension
                    imageUrl = NSBundle.mainBundle().URLForResource(fileNameWithoutExt, withExtension: ext)
                }
                
                if imageUrl != nil {
                    var imageData = NSData(contentsOfURL: imageUrl!)
                    let image = UIImage(data: imageData!)
                    pinView!.image = image
                }
            }
            pinView!.rightCalloutAccessoryView = UIButton.buttonWithType(UIButtonType.DetailDisclosure) as! UIView
        }
        
        return pinView
    }
    
    // when the annotation is clicked, open in maps so user can get to the location
    func mapView(mapView: MKMapView!, annotationView view: MKAnnotationView!, calloutAccessoryControlTapped control: UIControl!) {
        
        // todo: use a custom annotation to store the address?
        let location = view.annotation
        let coord = location.coordinate
        // location.subtitle
        let str = location.subtitle!
        let mapDictionary = [kABPersonAddressStreetKey as NSString: str]
       
        let placemark = MKPlacemark(coordinate: coord, addressDictionary: mapDictionary)
        let mapItem = MKMapItem(placemark: placemark)
        
        var launchOptions = [MKLaunchOptionsDirectionsModeKey : MKLaunchOptionsDirectionsModeDriving] as NSDictionary
        mapItem.openInMapsWithLaunchOptions(launchOptions as [NSObject : AnyObject])
        
       
    }
    
    func locationManager(_manager: CLLocationManager!, didUpdateLocations locations: [AnyObject]! )
    {
        self.mapView.showsUserLocation = true
    }
    

    /*
    // MARK: - Navigation

    // In a storyboard-based application, you will often want to do a little preparation before navigation
    override func prepareForSegue(segue: UIStoryboardSegue, sender: AnyObject?) {
        // Get the new view controller using segue.destinationViewController.
        // Pass the selected object to the new view controller.
    }
    */
    
    // MARK: private methods
    func loadAnnotations() {
        
        // this will add the annotations async...
        if (annotationUrl != nil) {
                        var url = NSURL(fileURLWithPath: annotationUrl!)
            // if scheme is "file", then the format is just the file name like foo.json or foo.png
            if url?.scheme! == "file" {
                let fileNameWithoutExt = annotationUrl!.stringByDeletingPathExtension
                let ext = annotationUrl!.pathExtension
                url = NSBundle.mainBundle().URLForResource(fileNameWithoutExt, withExtension: ext)
            }
            
            if url != nil {
                annotationToImage = [:]
                // Do any additional setup after loading the view, typically from a nib.
                let manager = AFHTTPRequestOperationManager()
                manager.GET( url?.absoluteString,
                    parameters: nil,
                    success: {[weak self]
                        operation, responseObject in
                        
                        //responseObject will be a JSON object
                        for annotationMap in responseObject?.objectForKey("items") as! [NSDictionary] {
                            if let lat = annotationMap["latitude"] as? Double {
                                // we have a lat
                                if let lon = annotationMap["longitude"] as? Double {
                                    let annotation = MKPointAnnotation()
                                    let location = CLLocationCoordinate2D(latitude: lat, longitude: lon)
                                    annotation.coordinate = location
                                    annotation.title = annotationMap["title"] as! String
                                    annotation.subtitle = annotationMap["subtitle"] as! String
                                    self?.mapView.addAnnotation(annotation)
                                    self?.annotationToImage?[annotation.title] = annotationMap["iconURL"] as! String
                                }
                            }
                        }
                        
                        // For iOS 7 and above (Referring MKMapView.h) : // Position the map such that the provided array of annotations are all visible to the fullest extent possible.
                        
                        
                        if self?.mapView.annotations?.count > 0 {
                            self?.mapView.showAnnotations(self?.mapView.annotations,
                                animated: false)

//                            if let a = self?.mapView.annotations?[0] as? MKPointAnnotation {
//                                let location = a.coordinate
//                                let span = MKCoordinateSpanMake(20.15, 30.15)
//                                let region = MKCoordinateRegion(center:location, span: span)
//                                self?.mapView.setRegion(region, animated: true)
//                                
//                            }
                        }
                    },
                    failure: {
                        operation, error in
                        
                        var alert = UIAlertController(title: "ERROR", message: error.localizedDescription, preferredStyle: UIAlertControllerStyle.Alert)
                        alert.addAction(UIAlertAction(title: "OK", style: UIAlertActionStyle.Default, handler: nil))
                        self.presentViewController(alert, animated: true, completion: nil)

                })
            } // if url != nil
        } // if annotation != nil
    }
    
}
